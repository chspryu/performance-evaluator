# 연주 평가 프로그램 — 기술 설계서

**문서 버전:** 1.0  
**작성일:** 2026-02-16  
**관련 문서:** [요구사항문서.md](./요구사항문서.md), [화면설계서.md](./화면설계서.md), [API명세서.md](./API명세서.md)

---

## 1. 개요

### 1.1 목적

연주 평가 서비스의 **시스템 구조**, **기술 스택**, **디렉터리 구조**, **핵심 처리 흐름**, **보안·배포** 방안을 정의하여 구현 및 유지보수에 활용한다.

### 1.2 설계 원칙

- **사용자 Gemini 계정 사용**: API 키는 사용자가 입력하고, 서버에서만 암호화 저장·사용.
- **단순성**: 초기에는 동기/단일 서버 구조로 시작, 필요 시 비동기·스케일 아웃 확장.
- **보안**: 업로드 파일·API 키·세션을 최소 권한으로 다루고, 평가 완료 후 **원본 업로드 파일**만 삭제. **평가 결과는 이력으로 저장**하여 목록·상세·삭제를 지원한다.

---

## 2. 시스템 아키텍처

### 2.1 전체 구성도

```
                    ┌─────────────────────────────────────────┐
                    │           클라이언트 (브라우저)            │
                    │  HTML/CSS/JS · 반응형 (PC/모바일)         │
                    └───────────────────┬─────────────────────┘
                                        │ HTTPS
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │              백엔드 서버                   │
                    │  ┌─────────────┐  ┌──────────────────┐  │
                    │  │ REST API    │  │ 파일 업로드       │  │
                    │  │ (설정/검증/  │  │ 악보·동영상       │  │
                    │  │  평가)      │  │ 임시 저장         │  │
                    │  └──────┬──────┘  └────────┬─────────┘  │
                    │         │                   │            │
                    │  ┌──────▼───────────────────▼────────┐  │
                    │  │  비즈니스 로직 · 오케스트레이션     │  │
                    │  │  - 세션/API키 매핑                 │  │
                    │  │  - YouTube 검증 · 미디어 준비     │  │
                    │  │  - Gemini 호출 · 결과 파싱        │  │
                    │  └──────┬────────────────────────────┘  │
                    │         │                                │
                    │  ┌──────▼──────┐  ┌──────────────┐  ┌──────────────────┐  │
                    │  │ 임시 스토리지 │  │ 평가 이력 DB  │  │ API 키 저장소    │  │
                    │  │ (악보/동영상) │  │ (목록/상세)   │  │ (암호화)         │  │
                    │  └─────────────┘  └──────────────┘  └──────────────────┘  │
                    └───────────────────┬─────────────────────┘
                                        │ HTTPS (API 호출)
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │         Google Gemini API                │
                    │  (이미지·비디오·텍스트 멀티모달)          │
                    └─────────────────────────────────────────┘
```

### 2.2 데이터 흐름 (평가 1회)

1. **클라이언트**: 악보 업로드 → `scoreId` 수신. 참조/본인 연주 URL 또는 본인 연주 파일 업로드 → `performanceId` 또는 URL 전달.
2. **백엔드**: API 키 조회(세션/쿠키 등과 매핑). 악보는 이미지(또는 PDF→이미지)로 준비. YouTube는 URL 전달 또는 오디오/영상 추출 후 파일 준비.
3. **Gemini**: 악보 이미지 + 참조 영상(또는 URL) + 본인 연주 영상(또는 URL) + 평가 프롬프트 전달 → 응답 텍스트 수신.
4. **백엔드**: 응답을 파싱하여 `totalScore`, `summary`, `sections` 구조로 변환. **평가 결과를 이력 DB에 저장**하고, 해당 요청에 사용된 **업로드 파일만** 삭제(또는 TTL 정책).
5. **클라이언트**: 결과 화면에 총점·요약·마디별 카드 표시. 이력 목록/상세/삭제는 별도 API로 제공.

---

## 3. 기술 스택

### 3.1 프론트엔드

| 구분 | 기술 | 비고 |
|------|------|------|
| 언어 | HTML5, CSS3, JavaScript (ES6+) | 또는 TypeScript |
| 프레임워크 | 바닐라 JS 또는 React/Vue 중 택 1 | SPA 권장(라우팅·상태 관리) |
| 스타일 | CSS Modules 또는 Tailwind 등 | 반응형 768px/480px 브레이크포인트 |
| HTTP | fetch 또는 axios | API 호출·에러 핸들링 통일 |
| 빌드 | Vite 또는 Create React App / Vue CLI | 번들·환경 변수 관리 |

### 3.2 백엔드

| 구분 | 기술 | 비고 |
|------|------|------|
| 런타임 | Node.js 18+ 또는 Python 3.10+ | 팀 숙련도에 따라 선택 |
| 프레임워크 | Express (Node) 또는 FastAPI (Python) | 파일 업로드·멀티파트 지원 |
| 멀티파트 | multer (Node) 또는 python-multipart | 대용량 동영상 업로드 |
| PDF/이미지 | pdf-to-img 또는 pdf2image (선택) | PDF → 이미지 변환 시 |

### 3.3 외부 연동

| 구분 | 기술 | 비고 |
|------|------|------|
| Gemini | @google/generative-ai (Node) 또는 google-generativeai (Python) | 멀티모달: 이미지·파일·URL |
| YouTube | oembed 또는 noembed API로 메타/재생 가능 여부 확인 | 다운로드 시 yt-dlp 등 (ToS 확인) |

### 3.4 스토리지·세션

| 구분 | 기술 | 비고 |
|------|------|------|
| 임시 파일 | 로컬 디렉터리 또는 S3 호환 스토리지 | **평가 완료 후 해당 요청의 원본 파일만 삭제** 또는 24시간 TTL |
| **평가 이력** | SQLite/PostgreSQL 또는 JSON 파일 등 | 세션 ID, createdAt, result, referenceYoutubeUrl, performanceType 등 저장. 목록/상세/삭제 API에서 사용 |
| API 키 저장 | 메모리(세션) + 선택적 DB/Redis | 암호화 후 저장 (AES-256 등) |
| 세션 | 쿠키 기반 세션 또는 JWT | 클라이언트와 서버 간 식별자 공유. 이력은 세션별로 조회·삭제 |

---

## 4. 디렉터리 구조 (제안)

```
performance-evaluator/
├── docs/                    # 요구사항·화면·API·기술설계
│   ├── 요구사항문서.md
│   ├── 화면설계서.md
│   ├── API명세서.md
│   └── 기술설계서.md
├── frontend/
│   ├── public/
│   ├── src/
│   │   ├── components/      # StepIndicator, FileDropZone, Card 등
│   │   ├── pages/            # 랜딩, 단계1~3, 평가중, 결과
│   │   ├── api/              # API 호출 래퍼
│   │   ├── hooks/
│   │   ├── styles/
│   │   └── App.jsx (또는 .tsx)
│   ├── package.json
│   └── vite.config.js (또는 craco 등)
├── backend/
│   ├── src/
│   │   ├── routes/           # settings, upload, validate, evaluate, history
│   │   ├── services/         # gemini, youtube, file
│   │   ├── middleware/       # 세션, API키 조회, 에러 핸들러
│   │   ├── config/
│   │   └── app.js (또는 main.py)
│   ├── uploads/              # 임시 업로드 (gitignore)
│   ├── package.json (또는 requirements.txt)
│   └── .env.example
├── .gitignore
└── README.md
```

---

## 5. 핵심 모듈 설계

### 5.1 API 키 관리

- **저장**: 사용자 식별(세션 ID 또는 익명 토큰) → API 키를 AES-256 등으로 암호화하여 메모리/DB/Redis에 저장.
- **조회**: 평가 요청 시 해당 세션의 키 복호화 후 Gemini 호출에만 사용. 응답에 키를 포함하지 않음.
- **만료**: 세션 만료 시 키도 삭제. "API 키 등록 여부" API는 키 존재 여부만 반환.

### 5.2 파일 업로드·임시 저장

- **경로**: `uploads/scores/{scoreId}`, `uploads/performances/{performanceId}`.
- **이름**: 원본 파일명 대신 UUID 기반 식별자로 저장하여 충돌·경로 조작 방지.
- **정리**: 평가 완료(성공/실패 무관) 후 **해당 요청에 사용된 악보·동영상 파일만** 삭제. 평가 **결과는 삭제하지 않고 이력 DB에 저장**하여 이력 목록/상세/삭제에서 사용. 또는 업로드 시각 기준 24시간 TTL로 미사용 파일 배치 삭제.

### 5.2.1 평가 이력 저장

- **저장 시점**: POST /evaluate 완료(동기 응답 또는 비동기 job 완료) 시, 결과(result)와 메타(referenceYoutubeUrl, performanceType, performanceSummary, createdAt, 세션 ID)를 이력 저장소에 저장.
- **식별자**: evaluationId(UUID 등) 부여. 응답 및 GET /history, GET /history/:id, DELETE /history/:id 에서 사용.
- **조회**: GET /history → 세션 ID로 필터, createdAt 최신순. GET /history/:id → evaluationId로 한 건 반환. 본 세션 소유만 허용.
- **삭제**: DELETE /history/:id → 해당 evaluationId의 이력만 삭제(세션 일치 시).

### 5.3 YouTube 처리

- **검증**: 공개 API(oembed 등)로 URL 유효성·제목·재생 가능 여부 확인. 비공개/삭제 시 `valid: false` 반환.
- **Gemini 전달**:  
  - **옵션 A**: Gemini가 YouTube URL을 지원하면 URL 문자열만 전달.  
  - **옵션 B**: 지원하지 않으면 서버에서 yt-dlp 등으로 오디오/영상 추출 후 파일로 전달. (YouTube ToS·저작권 준수 필요.)

### 5.4 악보 → 이미지

- PDF인 경우: 페이지별로 이미지 변환 후 Gemini에 여러 이미지로 전달.
- 이미지 업로드: 그대로 전달. 최대 해상도 제한(예: 4096px)은 Gemini 제한에 맞춤.

### 5.5 Gemini 호출

- **모델**: `gemini-1.5-flash` 또는 `gemini-1.5-pro` (비디오·이미지 입력 지원 버전).
- **입력**:  
  - 시스템 프롬프트: 역할(연주 평가자), 출력 형식(JSON 또는 마크다운 구조), 100점 만점·기술/표현·마디별 차이·개선 제안 요청.  
  - 사용자 메시지: 악보 이미지(들) + 참조 연주(URL 또는 파일) + 본인 연주(URL 또는 파일)에 대한 설명.
- **출력 파싱**: 응답 텍스트에서 `totalScore`, `summary.technical`, `summary.expression`, `sections[]` 추출. JSON이 아니면 정규식/구조 파싱으로 필드 매핑.

### 5.6 평가 작업 (비동기 시)

- **생성**: POST /evaluate 시 jobId(UUID) 생성, DB 또는 Redis에 `status: processing` 저장.
- **처리**: 백그라운드 워커 또는 동일 프로세스 내 비동기 작업으로 Gemini 호출 → 완료 시 `status: completed`, `result` 저장. 실패 시 `status: failed`, `errorMessage` 저장.
- **조회**: GET /evaluate/:jobId 에서 저장된 상태/결과 반환. 클라이언트는 2~5초 간격 폴링.

---

## 6. 보안 설계

### 6.1 API 키

- 전송: HTTPS만 사용. 클라이언트 → 서버는 POST body에 평문 전송 후 서버에서 즉시 암호화.
- 저장: AES-256-GCM 등, 키는 환경 변수로 관리(서버만 보유).
- 로그: API 키 값은 절대 로그·에러 메시지에 포함하지 않음.

### 6.2 업로드 파일

- 확장자·MIME 타입 화이트리스트 검사. 실행 가능 파일 업로드 차단.
- 파일명: 원본 대신 내부 식별자 사용. 다운로드 시에는 원본 파일명만 응답 헤더에 사용(필요 시).
- 용량 제한: 악보 20MB, 동영상 500MB (설정 가능).

### 6.3 세션·요청

- CORS: 프론트 오리진만 허용. 쿠키 사용 시 SameSite, Secure.
- Rate limiting: IP 또는 세션당 평가 요청 횟수 제한(예: 분당 2회).
- 입력 검증: scoreId, performanceId, jobId는 UUID/정해진 형식만 허용. 경로 조작 방지.

---

## 7. 환경 설정·배포

### 7.1 환경 변수 (백엔드)

| 변수명 | 설명 | 예시 |
|--------|------|------|
| NODE_ENV | development / production | production |
| PORT | 서버 포트 | 3000 |
| FRONTEND_ORIGIN | CORS 허용 오리진 | https://app.example.com |
| ENCRYPTION_KEY | API 키 암호화용 키 (32바이트) | env에서 로드 |
| UPLOAD_DIR | 임시 업로드 루트 | ./uploads |
| MAX_SCORE_SIZE_MB | 악보 최대 용량(MB) | 20 |
| MAX_VIDEO_SIZE_MB | 동영상 최대 용량(MB) | 500 |

### 7.2 배포 구성 (참고)

- **프론트**: 정적 빌드 후 Nginx 또는 Vercel/Netlify 등에 호스팅. API는 백엔드 URL로 프록시 또는 직접 호출.
- **백엔드**: 단일 인스턴스(PM2, gunicorn 등) 또는 Docker 컨테이너. HTTPS는 리버스 프록시(Nginx) 또는 로드밸런서에서 처리.
- **파일**: 단일 서버면 로컬 디스크. 다중 인스턴스면 S3 호환 스토리지 + 공유 세션(Redis) 고려.

### 7.3 로그·모니터링

- 액세스 로그: 요청 경로·메서드·상태 코드·처리 시간. 본문·API 키 미포함.
- 에러 로그: 스택 트레이스는 개발 환경에서만 상세 출력. 프로덕션에서는 에러 코드와 요약만.
- 모니터링: 평가 요청 수, 평균 응답 시간, Gemini 오류 비율 등 (선택).

---

## 8. 제약·확장

### 8.1 제약

- **Gemini**: 비디오 길이·용량 제한 있음. 긴 영상은 구간 잘라서 전달하거나 사용자에게 길이 제한 안내.
- **YouTube**: 다운로드 시 해당 지역·ToS 적용. 가능하면 URL 전달만 사용.
- **악보**: 손글씨·저해상도는 인식 정확도 저하 가능 → 안내 문구 권장.

### 8.2 확장 시 고려

- **이력**: 기본으로 목록·상세·삭제 제공. 확장 시 이력 목록에 점수 추이 차트(그래프) 추가.
- **큐**: 평가 요청을 Redis Queue 등에 넣고 워커가 순차 처리하여 서버 부하 분산.
- **OAuth**: Google 로그인 후 Vertex AI 또는 Gemini API를 서버 측에서 사용자 토큰으로 호출 (구현 복잡도 높음).

---

## 9. 문서 이력

| 버전 | 일자 | 변경 내용 |
|------|------|-----------|
| 1.0 | 2026-02-16 | 최초 작성 |
| 1.1 | 2026-02-16 | 평가 이력 저장·DB·파일 정리 정책(원본만 삭제)·이력 API 반영 |
