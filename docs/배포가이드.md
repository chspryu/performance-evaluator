# 연주 평가기 배포 가이드

로컬이 아닌 **다른 PC(다른 사람)에서도** 사용하려면, 서버를 **인터넷에 올려두고** 접속할 수 있는 URL을 만들어야 합니다.

---

## 1. 배포 방식 요약

| 방식 | 설명 | 난이도 |
|------|------|--------|
| **한 서버에 함께 배포** | 백엔드가 프론트 빌드 파일까지 서빙. URL 하나로 접속. | ★ 쉬움 (권장) |
| 프론트/백엔드 분리 | 프론트는 Vercel, 백엔드는 Railway 등에 따로 배포. | ★★ |

아래는 **한 서버에 함께 배포**하는 방법을 기준으로 설명합니다.

---

## 2. 배포 전 준비

### 2.1 Node.js

- Node 18 이상 권장 (로컬과 동일한 버전 사용하면 좋음).

### 2.2 환경 변수 (필수/권장)

배포하는 서버(또는 호스팅 대시보드)에서 다음을 설정합니다.

| 변수 | 필수 | 설명 |
|------|------|------|
| `NODE_ENV` | 권장 | `production` 으로 설정하면 프론트 빌드를 같은 서버에서 서빙합니다. |
| `PORT` | 선택 | 서버 포트. 미설정 시 3000. (Railway/Render 등은 자동 지정하는 경우 많음) |
| `SESSION_SECRET` | **필수** | 세션 암호화용. **반드시 로컬과 다른 랜덤 문자열**로 설정하세요. |
| `FRONTEND_ORIGIN` | 선택 | 프론트를 **다른 도메인**에 둘 때만 설정. 같은 서버에서 서빙하면 비워두면 됨. |
| `GEMINI_API_KEY` / `OPENAI_API_KEY` | 선택 | 기본 API 키. 없으면 사용자가 설정 화면에서 입력. |

예시 (직접 서버에 올릴 때):

```bash
export NODE_ENV=production
export SESSION_SECRET=아주긴랜덤문자열여기에
# export PORT=3000
```

---

## 3. 한 서버에 함께 배포 (권장)

백엔드가 **프론트 빌드 결과물**을 함께 서빙하므로, 사용자는 **한 주소**로만 접속하면 됩니다.

### 3.1 빌드 순서

1. **프론트 빌드**

   ```bash
   cd frontend
   npm ci
   npm run build
   ```

2. **백엔드 실행** (프론트는 이미 `frontend/dist`에 있음)

   ```bash
   cd ../backend
   npm ci
   NODE_ENV=production node src/server.js
   ```

   또는 포트 지정:

   ```bash
   NODE_ENV=production PORT=3000 node src/server.js
   ```

3. 브라우저에서 `http://서버주소:3000` 으로 접속합니다.

### 3.2 프로덕션 동작

- `NODE_ENV=production` 이면 백엔드가 `frontend/dist` 폴더를 정적 파일로 서빙합니다.
- `/api/v1/...` 요청만 API로 처리하고, 나머지 경로는 `index.html`(SPA)로 보냅니다.

---

## 4. 호스팅 서비스에 올리기

아래 서비스들은 **무료/저렴한 티어**로 다른 PC에서 접속 가능한 URL을 만들어 줍니다.

### 4.1 Railway

1. [railway.app](https://railway.app) 가입 후 새 프로젝트 생성.
2. GitHub 저장소 연결 후 **루트가 `performance-evaluator`** 이면, 루트에서 빌드/시작해야 하므로:
   - **Build Command**: `cd frontend && npm ci && npm run build && cd ../backend && npm ci`
   - **Start Command**: `cd backend && NODE_ENV=production node src/server.js`
   - **Root Directory**: 프로젝트 루트로 두거나, `backend`만 배포하려면 빌드 시 프론트를 `backend/../frontend` 에 두는 구조가 맞는지 확인.
3. 더 단순하게 하려면:
   - **Root Directory**: 비움(전체 저장소).
   - **Build**: `cd frontend && npm ci && npm run build && cd ../backend && npm ci`
   - **Start**: `cd backend && NODE_ENV=production node src/server.js`
4. **Variables**에 `SESSION_SECRET`, 필요 시 `NODE_ENV=production` 추가.
5. 배포 후 생성된 URL(예: `https://xxx.railway.app`)로 접속.

### 4.2 Render

1. [render.com](https://render.com) 가입 후 **Web Service** 생성.
2. 저장소 연결.
3. **Build Command**:  
   `cd frontend && npm ci && npm run build && cd ../backend && npm ci`
4. **Start Command**:  
   `cd backend && NODE_ENV=production node src/server.js`
5. **Environment**: `NODE_ENV=production`, `SESSION_SECRET=...` 설정.
6. Render가 제공하는 URL로 접속.

### 4.3 직접 서버(VPS)에 배포

- Ubuntu 등 Linux 서버에 Node 설치 후, 위 3.1 순서대로 빌드하고 `node src/server.js` 실행.
- 외부 접속을 위해 **방화벽**에서 해당 포트(예: 3000) 개방.
- 도메인을 쓰려면 Nginx로 리버스 프록시 후 HTTPS 적용 권장.

---

## 5. 주의사항

- **SESSION_SECRET**: 배포 환경에서는 꼭 **강한 랜덤 값**으로 설정하세요. 기본값(`dev-secret`)은 로컬 전용입니다.
- **업로드/이력 데이터**: 현재는 서버의 `uploads/`, `data/` 폴더에 저장됩니다. 호스팅이 **재시작 시 디스크를 비우는** 환경이면 데이터가 사라질 수 있으므로, 장기 운영 시에는 외부 스토리지/DB 연동을 고려하세요.
- **API 키**: 사용자가 설정 화면에서 본인 Gemini/OpenAI 키를 입력해 쓰는 방식이면, 서버에 기본 API 키를 둘 필요는 없습니다.

---

## 6. 다른 PC에서 접속

배포가 끝나면:

1. 배포된 URL(예: `https://your-app.railway.app`)을 엽니다.
2. **설정**에서 원하는 AI(Gemini 또는 ChatGPT)와 API 키를 입력해 저장합니다.
3. 악보·참조 연주·본인 연주를 넣고 평가를 진행하면 됩니다.

같은 URL만 알려주면 **다른 사람들도 각자 PC/폰에서** 그 주소로 들어와 사용할 수 있습니다.
